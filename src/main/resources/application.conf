# Snowflake to Kafka CDC Configuration
app {
  name = "snowflake-kafka-cdc"
  version = "1.0.0"
}

# Snowflake Configuration
snowflake {
  # Connection settings
  account = ${?SNOWFLAKE_ACCOUNT}
  user = ${?SNOWFLAKE_USER}
  
  # Authentication method: "password" or "keypair"
  auth-method = ${?SNOWFLAKE_AUTH_METHOD}
  
  # Password authentication (legacy)
  password = ${?SNOWFLAKE_PASSWORD}
  
  # Key-pair authentication (enterprise)
  private-key-path = ${?SNOWFLAKE_PRIVATE_KEY_PATH}
  private-key-passphrase = ${?SNOWFLAKE_PRIVATE_KEY_PASSPHRASE}
  
  warehouse = ${?SNOWFLAKE_WAREHOUSE}
  database = ${?SNOWFLAKE_DATABASE}
  schema = ${?SNOWFLAKE_SCHEMA}
  role = ${?SNOWFLAKE_ROLE}
  
  # Connection pool settings
  connection-pool {
    maximum-pool-size = 20
    minimum-idle = 5
    connection-timeout = 30000
    idle-timeout = 600000
    max-lifetime = 1800000
    leak-detection-threshold = 60000
  }
  
  # Stream processing settings
  streams {
    # List of streams to monitor
    stream-names = [
      "CUSTOMER_STREAM",
      "ORDER_STREAM", 
      "PRODUCT_STREAM"
    ]
    
    # Polling configuration
    poll-interval-ms = 1000
    batch-size = 10000
    max-wait-time-ms = 5000
    
    # Query timeout
    query-timeout-seconds = 300
    
    # Retry configuration
    max-retries = 3
    retry-delay-ms = 1000
    exponential-backoff = true
  }
}

# Kafka Configuration
kafka {
  # Bootstrap servers
  bootstrap-servers = ${?KAFKA_BOOTSTRAP_SERVERS}
  
  # Security configuration
  security {
    # Security protocol: PLAINTEXT, SSL, SASL_PLAINTEXT, SASL_SSL
    protocol = ${?KAFKA_SECURITY_PROTOCOL}
    
    # SSL configuration
    ssl {
      keystore-location = ${?KAFKA_SSL_KEYSTORE_LOCATION}
      keystore-password = ${?KAFKA_SSL_KEYSTORE_PASSWORD}
      truststore-location = ${?KAFKA_SSL_TRUSTSTORE_LOCATION}
      truststore-password = ${?KAFKA_SSL_TRUSTSTORE_PASSWORD}
      enable-hostname-verification = true
    }
    
    # SASL configuration
    sasl {
      mechanism = ${?KAFKA_SASL_MECHANISM}
      username = ${?KAFKA_SASL_USERNAME}
      password = ${?KAFKA_SASL_PASSWORD}
      jaas-config = ${?KAFKA_SASL_JAAS_CONFIG}
    }
  }
  
  # Producer configuration for maximum throughput
  producer {
    # Performance settings (enterprise-grade)
    acks = "all"
    retries = 2147483647
    max-in-flight-requests-per-connection = 5
    enable-idempotence = true
    
    # Batching for maximum throughput
    batch-size = 131072  # 128KB
    linger-ms = 5        # Reduced for lower latency
    buffer-memory = 268435456  # 256MB
    
    # Compression (enterprise)
    compression-type = "zstd"  # Best compression ratio
    
    # Serialization
    key-serializer = "org.apache.kafka.common.serialization.StringSerializer"
    value-serializer = "org.apache.kafka.common.serialization.StringSerializer"
    
    # Timeouts (enterprise)
    request-timeout-ms = 60000
    delivery-timeout-ms = 300000
    
    # Connection settings
    connections-max-idle-ms = 540000
    reconnect-backoff-ms = 50
    reconnect-backoff-max-ms = 1000
    
    # Metrics
    metrics-sample-window-ms = 30000
    metrics-num-samples = 2
  }
  
  # Topic configuration
  topics {
    # Default topic prefix
    prefix = "snowflake-cdc"
    
    # Topic mapping (stream_name -> topic_name)
    mapping {
      CUSTOMER_STREAM = "customer-changes"
      ORDER_STREAM = "order-changes"
      PRODUCT_STREAM = "product-changes"
    }
    
    # Default topic for unmapped streams
    default-topic = "snowflake-changes"
  }
}

# Performance Configuration (Enterprise-Grade)
performance {
  # Thread pool settings (optimized for high throughput)
  core-threads = 8
  max-threads = 32
  queue-capacity = 10000
  keep-alive-seconds = 300
  
  # Async processing (enterprise)
  async-processing = true
  async-queue-size = 100000
  
  # Batch processing (maximum throughput)
  enable-batching = true
  batch-timeout-ms = 50  # Reduced for lower latency
  max-batch-size = 50000
  
  # Memory settings (enterprise)
  max-memory-mb = 8192
  gc-threshold-mb = 6144
  
  # Connection optimization
  connection-pool-size = 50
  connection-timeout-ms = 10000
  
  # I/O optimization
  io-threads = 16
  network-threads = 8
  socket-send-buffer-bytes = 131072
  socket-receive-buffer-bytes = 131072
}

# Monitoring Configuration (Enterprise)
monitoring {
  # JMX Metrics (Enterprise)
  enable-jmx-metrics = true
  jmx-port = 9999
  jmx-domain = "com.snowflake.kafka.cdc"
  
  # Health check
  health-check-port = 8081
  health-check-path = "/health"
  
  # Enterprise logging
  log-level = "INFO"
  log-performance-stats = true
  stats-interval-seconds = 15  # More frequent for enterprise monitoring
  
  # Alerting thresholds
  error-rate-threshold = 0.05  # 5%
  latency-threshold-ms = 1000
  memory-threshold-percent = 85
  
  # Audit logging
  enable-audit-log = true
  audit-log-path = "/var/log/snowflake-kafka-cdc/audit.log"
}

# Error Handling
error-handling {
  # Dead letter queue
  enable-dlq = true
  dlq-topic = "snowflake-cdc-errors"
  
  # Retry policy
  max-retries = 3
  retry-delay-ms = 1000
  exponential-backoff = true
  max-retry-delay-ms = 30000
  
  # Circuit breaker
  enable-circuit-breaker = true
  failure-threshold = 10
  recovery-timeout-ms = 60000
}
